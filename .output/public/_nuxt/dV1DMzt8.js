import{_ as Z}from"./Bno8S_cx.js";import{b as ee,S as ae,j as n,G as te,g as I,k,l as u,y as s,s as r,B as i,o as $,D as v,W as m,N as P,F as le,m as se,as as ie,ak as re,aj as oe}from"./vp8MPyNN.js";import{a as g,u as ne,b as ue,c as j,e as B}from"./DWH2qXdP.js";import{u as de}from"./ybW-YjLz.js";import{N as ce,a as d}from"./DToeYN_d.js";import{N as y}from"./Bw_fySTz.js";import{N as S}from"./uD4T5QrJ.js";import{N as T}from"./r23Yv2v_.js";import"./CXuCsgek.js";const pe={class:"container mx-auto px-4 py-8",dir:"rtl"},ve={class:"mb-5 flex items-center justify-between gap-3"},fe={class:"pt-2 flex items-center gap-2"},me={class:"space-y-3"},ge={class:"flex items-center gap-3"},ye={class:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3"},be=["src"],De={class:"flex items-center justify-between mt-2"},xe=ee({__name:"[id]",setup(we){const z=ae(),c=String(z.params.id),f=de(),U=n(null),t=n({name:"",slug:"",shortDescription:"",longDescription:"",price:0,brandID:"",categoryID:"",statusID:"",isActive:!0}),A=n(!1),h=n(!1),x=n([]),C=n([]),F=n([]),N=n([]),_=n(!1),b=n(null);te(async()=>{await Promise.all([G(),M(),D()])});async function G(){try{Object.assign(t.value,await g(`/products/${c}`)||{})}catch{f.error("خواندن محصول ناموفق بود")}}async function M(){try{const[a,e,o]=await Promise.all([g("/brands",{params:{limit:100,offset:0}}),g("/categories",{params:{limit:100,offset:0}}),g("/product-statuses")]);x.value=Array.isArray(a?.items)?a.items:[],C.value=Array.isArray(e?.items)?e.items:[],F.value=Array.isArray(o)?o:Array.isArray(o?.items)?o.items:[]}catch{}}async function D(){try{N.value=await g(`/products/${c}/galleries`)}catch{N.value=[]}}const R=I(()=>x.value.map(a=>({label:a.name||a.slug||a.id,value:a.id}))),V=I(()=>C.value.map(a=>({label:a.name||a.slug||a.id,value:a.id}))),q=I(()=>F.value.map(a=>({label:a.name||a.title||a.id||String(a),value:a.id||a.value||String(a)}))),O=I({get:()=>t.value.price?String(t.value.price):"",set:a=>t.value.price=Number(a.replace(/[^\d]/g,""))||0}),L={name:{required:!0,message:"نام الزامی است",trigger:"blur"},price:{required:!0,message:"قیمت الزامی است",trigger:"blur"}};async function E(){if(!(!t.value.name||t.value.slug))try{const{slug:a}=await ne()("utils/slug/preview",{method:"POST",body:{model:"product",source:t.value.name,excludeId:c}});a&&(t.value.slug=a)}catch{}}async function W(){try{await U.value?.validate()}catch{return}A.value=!0;try{await ue(`/products/${c}`,{name:t.value.name,shortDescription:t.value.shortDescription||void 0,longDescription:t.value.longDescription||void 0,price:t.value.price,statusID:t.value.statusID||void 0,brandID:t.value.brandID||void 0,categoryID:t.value.categoryID||void 0,slug:t.value.slug||void 0,isActive:t.value.isActive}),f.success("ذخیره شد")}catch(a){f.error(a?.data?.message||"خطا در ذخیره")}finally{A.value=!1}}async function H(){if(confirm("حذف محصول؟")){h.value=!0;try{await j(`/products/${c}`),ie("/admin/products")}catch(a){f.error(a?.data?.message||"خطا در حذف")}finally{h.value=!1}}}function J(a){if(!a)return"";const o=re().public.apiOrigin||(typeof window<"u"?window.location.origin:"");return`${String(o).replace(/\/$/,"")}/uploads/${a.replace(/^\/+/,"")}`}async function K(){const a=Array.from(b.value?.files||[]);if(a.length){_.value=!0;try{const e=new FormData;e.append("scope",`products/${c}`);for(const w of a)e.append("files",w);const{$apiFetch:o}=oe(),l=await o("files/upload/multi",{method:"POST",body:e}),p=Array.isArray(l?.files)?l.files:[];for(const w of p)await o(`products/${c}/galleries`,{method:"POST",body:{path:w.path,fileName:w.fileName}});b.value&&(b.value.value=""),await D(),f.success("تصاویر افزوده شد")}catch(e){f.error(e?.data?.message||"خطا در آپلود")}finally{_.value=!1}}}async function Q(a){try{await B(`/galleries/${a.id}/main`),await D()}catch{}}async function X(a,e){try{await B(`/galleries/${a.id}`,{isActive:e})}catch{}}async function Y(a){if(confirm("حذف تصویر؟"))try{await j(`/galleries/${a.id}`),await D()}catch{}}return(a,e)=>{const o=Z;return $(),k("section",pe,[u("div",ve,[e[10]||(e[10]=u("h1",{class:"text-xl font-bold"},"ویرایش محصول",-1)),s(o,{to:"/admin/products",class:"text-sky-600 hover:underline text-sm"},{default:r(()=>[...e[9]||(e[9]=[v("بازگشت",-1)])]),_:1})]),s(i(P),{class:"rounded-2xl ring-1 ring-slate-200/80 shadow-sm mb-6",bordered:!1},{default:r(()=>[s(i(ce),{model:t.value,rules:L,ref_key:"formRef",ref:U,"label-placement":"left","label-width":"140"},{default:r(()=>[s(i(d),{label:"نام",path:"name"},{default:r(()=>[s(i(y),{value:t.value.name,"onUpdate:value":e[0]||(e[0]=l=>t.value.name=l),onBlur:E},null,8,["value"])]),_:1}),s(i(d),{label:"اسلاگ",path:"slug"},{default:r(()=>[s(i(y),{value:t.value.slug,"onUpdate:value":e[1]||(e[1]=l=>t.value.slug=l)},null,8,["value"])]),_:1}),s(i(d),{label:"خلاصه",path:"shortDescription"},{default:r(()=>[s(i(y),{value:t.value.shortDescription,"onUpdate:value":e[2]||(e[2]=l=>t.value.shortDescription=l),type:"textarea"},null,8,["value"])]),_:1}),s(i(d),{label:"توضیح کامل",path:"longDescription"},{default:r(()=>[s(i(y),{value:t.value.longDescription,"onUpdate:value":e[3]||(e[3]=l=>t.value.longDescription=l),type:"textarea"},null,8,["value"])]),_:1}),s(i(d),{label:"قیمت (تومان)",path:"price"},{default:r(()=>[s(i(y),{value:O.value,"onUpdate:value":e[4]||(e[4]=l=>O.value=l)},null,8,["value"])]),_:1}),s(i(d),{label:"برند",path:"brandID"},{default:r(()=>[s(i(S),{value:t.value.brandID,"onUpdate:value":e[5]||(e[5]=l=>t.value.brandID=l),options:R.value,filterable:"",clearable:""},null,8,["value","options"])]),_:1}),s(i(d),{label:"دسته‌بندی",path:"categoryID"},{default:r(()=>[s(i(S),{value:t.value.categoryID,"onUpdate:value":e[6]||(e[6]=l=>t.value.categoryID=l),options:V.value,filterable:"",clearable:""},null,8,["value","options"])]),_:1}),s(i(d),{label:"وضعیت",path:"statusID"},{default:r(()=>[s(i(S),{value:t.value.statusID,"onUpdate:value":e[7]||(e[7]=l=>t.value.statusID=l),options:q.value,filterable:"",clearable:""},null,8,["value","options"])]),_:1}),s(i(d),{label:"فعال"},{default:r(()=>[s(i(T),{value:t.value.isActive,"onUpdate:value":e[8]||(e[8]=l=>t.value.isActive=l)},null,8,["value"])]),_:1}),u("div",fe,[s(i(m),{type:"primary",loading:A.value,onClick:W},{default:r(()=>[...e[11]||(e[11]=[v("ذخیره",-1)])]),_:1},8,["loading"]),s(i(m),{type:"error",secondary:"",loading:h.value,onClick:H},{default:r(()=>[...e[12]||(e[12]=[v("حذف",-1)])]),_:1},8,["loading"])])]),_:1},8,["model"])]),_:1}),s(i(P),{class:"rounded-2xl ring-1 ring-slate-200/80 shadow-sm",bordered:!1},{header:r(()=>[...e[13]||(e[13]=[v("گالری تصاویر",-1)])]),default:r(()=>[u("div",me,[u("div",ge,[u("input",{ref_key:"fileInput",ref:b,type:"file",multiple:"",accept:"image/*"},null,512),s(i(m),{loading:_.value,size:"small",onClick:K},{default:r(()=>[...e[14]||(e[14]=[v("آپلود تصاویر",-1)])]),_:1},8,["loading"])]),u("div",ye,[($(!0),k(le,null,se(N.value,l=>($(),k("div",{key:l.id,class:"rounded-xl border border-slate-200 p-2"},[u("img",{src:J(l.path),class:"h-28 w-full object-cover rounded-lg"},null,8,be),u("div",De,[s(i(m),{size:"tiny",type:l.isMain?"primary":"default",onClick:p=>Q(l)},{default:r(()=>[...e[15]||(e[15]=[v("اصلی",-1)])]),_:1},8,["type","onClick"]),s(i(T),{size:"small",value:l.isActive,"onUpdate:value":[p=>l.isActive=p,p=>X(l,p)]},null,8,["value","onUpdate:value"]),s(i(m),{size:"tiny",type:"error",secondary:"",onClick:p=>Y(l)},{default:r(()=>[...e[16]||(e[16]=[v("حذف",-1)])]),_:1},8,["onClick"])])]))),128))])])]),_:1})])}}});export{xe as default};
