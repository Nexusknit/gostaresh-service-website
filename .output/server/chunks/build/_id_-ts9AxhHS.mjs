import{_ as e}from"./nuxt-link-DlD_4d-2.mjs";import{defineComponent as a,ref as l,computed as t,mergeProps as u,withCtx as r,createTextVNode as i,unref as n,createVNode as o,createBlock as s,openBlock as v,Fragment as d,renderList as p,useSSRContext as c}from"vue";import{ssrRenderAttrs as m,ssrRenderComponent as f,ssrRenderList as g,ssrRenderAttr as b}from"vue/server-renderer";import{useRoute as y}from"vue-router";import{u as D,a as h,b as U,e as _,c as I}from"./api-qvnChiK5.mjs";import{N as x,C as w,F as A,A as S,B as $}from"./server.mjs";import{u as k}from"./use-message-DH0YWJK4.mjs";import{N as j,a as C}from"./FormItem-Ds_MAETL.mjs";import{N as z}from"./Input-DBNoyZOz.mjs";import{N}from"./Select-C0U9uRTf.mjs";import{N as G}from"./Switch-DTUH-ntq.mjs";import"../_/nitro.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:url";import"@iconify/utils";import"node:crypto";import"consola";import"node:path";import"pinia";import"@iconify/vue";import"@css-render/vue3-ssr";import"seemly";import"@css-render/plugin-bem";import"css-render";import"lodash-es";import"evtd";import"../routes/renderer.mjs";import"vue-bundle-renderer/runtime";import"unhead/server";import"devalue";import"unhead/plugins";import"unhead/utils";import"async-validator";import"date-fns/locale";import"treemate";import"./Tag-BJGgCXYj.mjs";import"@juggle/resize-observer";const B=a({__name:"[id]",__ssrInlineRender:!0,setup(a){const c=y(),B=String(c.params.id),T=k(),M=l(null),O=l({name:"",slug:"",shortDescription:"",longDescription:"",price:0,brandID:"",categoryID:"",statusID:"",isActive:!0}),q=l(!1),F=l(!1),R=l([]),P=l([]),H=l([]),J=l([]),K=l(!1),Y=l(null);async function fetchGalleries(){try{J.value=await I(`/products/${B}/galleries`)}catch{J.value=[]}}const E=t(()=>R.value.map(e=>({label:e.name||e.slug||e.id,value:e.id}))),L=t(()=>P.value.map(e=>({label:e.name||e.slug||e.id,value:e.id}))),W=t(()=>H.value.map(e=>({label:e.name||e.title||e.id||String(e),value:e.id||e.value||String(e)}))),X=t({get:()=>O.value.price?String(O.value.price):"",set:e=>O.value.price=Number(e.replace(/[^\d]/g,""))||0}),Z={name:{required:!0,message:"نام الزامی است",trigger:"blur"},price:{required:!0,message:"قیمت الزامی است",trigger:"blur"}};async function ensureSlug(){if(O.value.name&&!O.value.slug)try{const{slug:e}=await D()("utils/slug/preview",{method:"POST",body:{model:"product",source:O.value.name,excludeId:B}});e&&(O.value.slug=e)}catch{}}async function onSubmit(){try{await(M.value?.validate())}catch{return}q.value=!0;try{await h(`/products/${B}`,{name:O.value.name,shortDescription:O.value.shortDescription||void 0,longDescription:O.value.longDescription||void 0,price:O.value.price,statusID:O.value.statusID||void 0,brandID:O.value.brandID||void 0,categoryID:O.value.categoryID||void 0,slug:O.value.slug||void 0,isActive:O.value.isActive}),T.success("ذخیره شد")}catch(e){T.error(e?.data?.message||"خطا در ذخیره")}finally{q.value=!1}}async function onDelete(){if(confirm("حذف محصول؟")){F.value=!0;try{await U(`/products/${B}`),A("/admin/products")}catch(e){T.error(e?.data?.message||"خطا در حذف")}finally{F.value=!1}}}function fullUrl(e){if(!e)return"";const a=$().public.apiOrigin||"";return`${String(a).replace(/\/$/,"")}/uploads/${e.replace(/^\/+/,"")}`}async function uploadSelected(){const e=Array.from(Y.value?.files||[]);if(e.length){K.value=!0;try{const a=new FormData;a.append("scope",`products/${B}`);for(const l of e)a.append("files",l);const{$apiFetch:l}=S(),t=await l("files/upload/multi",{method:"POST",body:a}),u=Array.isArray(t?.files)?t.files:[];for(const e of u)await l(`products/${B}/galleries`,{method:"POST",body:{path:e.path,fileName:e.fileName}});Y.value&&(Y.value.value=""),await fetchGalleries(),T.success("تصاویر افزوده شد")}catch(e){T.error(e?.data?.message||"خطا در آپلود")}finally{K.value=!1}}}async function setMain(e){try{await _(`/galleries/${e.id}/main`),await fetchGalleries()}catch{}}async function toggleActive(e,a){try{await _(`/galleries/${e.id}`,{isActive:a})}catch{}}async function removeGallery(e){if(confirm("حذف تصویر؟"))try{await U(`/galleries/${e.id}`),await fetchGalleries()}catch{}}return(a,l,t,c)=>{const y=e;l(`<section${m(u({class:"container mx-auto px-4 py-8",dir:"rtl"},c))}><div class="mb-5 flex items-center justify-between gap-3"><h1 class="text-xl font-bold">ویرایش محصول</h1>`),l(f(y,{to:"/admin/products",class:"text-sky-600 hover:underline text-sm"},{default:r((e,a,l,t)=>{if(!a)return[i("بازگشت")];a("بازگشت")}),_:1},t)),l("</div>"),l(f(n(x),{class:"rounded-2xl ring-1 ring-slate-200/80 shadow-sm mb-6",bordered:!1},{default:r((e,a,l,t)=>{if(!a)return[o(n(j),{model:O.value,rules:Z,ref_key:"formRef",ref:M,"label-placement":"left","label-width":"140"},{default:r(()=>[o(n(C),{label:"نام",path:"name"},{default:r(()=>[o(n(z),{value:O.value.name,"onUpdate:value":e=>O.value.name=e,onBlur:ensureSlug},null,8,["value","onUpdate:value"])]),_:1}),o(n(C),{label:"اسلاگ",path:"slug"},{default:r(()=>[o(n(z),{value:O.value.slug,"onUpdate:value":e=>O.value.slug=e},null,8,["value","onUpdate:value"])]),_:1}),o(n(C),{label:"خلاصه",path:"shortDescription"},{default:r(()=>[o(n(z),{value:O.value.shortDescription,"onUpdate:value":e=>O.value.shortDescription=e,type:"textarea"},null,8,["value","onUpdate:value"])]),_:1}),o(n(C),{label:"توضیح کامل",path:"longDescription"},{default:r(()=>[o(n(z),{value:O.value.longDescription,"onUpdate:value":e=>O.value.longDescription=e,type:"textarea"},null,8,["value","onUpdate:value"])]),_:1}),o(n(C),{label:"قیمت (تومان)",path:"price"},{default:r(()=>[o(n(z),{value:X.value,"onUpdate:value":e=>X.value=e},null,8,["value","onUpdate:value"])]),_:1}),o(n(C),{label:"برند",path:"brandID"},{default:r(()=>[o(n(N),{value:O.value.brandID,"onUpdate:value":e=>O.value.brandID=e,options:E.value,filterable:"",clearable:""},null,8,["value","onUpdate:value","options"])]),_:1}),o(n(C),{label:"دسته‌بندی",path:"categoryID"},{default:r(()=>[o(n(N),{value:O.value.categoryID,"onUpdate:value":e=>O.value.categoryID=e,options:L.value,filterable:"",clearable:""},null,8,["value","onUpdate:value","options"])]),_:1}),o(n(C),{label:"وضعیت",path:"statusID"},{default:r(()=>[o(n(N),{value:O.value.statusID,"onUpdate:value":e=>O.value.statusID=e,options:W.value,filterable:"",clearable:""},null,8,["value","onUpdate:value","options"])]),_:1}),o(n(C),{label:"فعال"},{default:r(()=>[o(n(G),{value:O.value.isActive,"onUpdate:value":e=>O.value.isActive=e},null,8,["value","onUpdate:value"])]),_:1}),o("div",{class:"pt-2 flex items-center gap-2"},[o(n(w),{type:"primary",loading:q.value,onClick:onSubmit},{default:r(()=>[i("ذخیره")]),_:1},8,["loading"]),o(n(w),{type:"error",secondary:"",loading:F.value,onClick:onDelete},{default:r(()=>[i("حذف")]),_:1},8,["loading"])])]),_:1},8,["model"])];a(f(n(j),{model:O.value,rules:Z,ref_key:"formRef",ref:M,"label-placement":"left","label-width":"140"},{default:r((e,a,l,t)=>{if(!a)return[o(n(C),{label:"نام",path:"name"},{default:r(()=>[o(n(z),{value:O.value.name,"onUpdate:value":e=>O.value.name=e,onBlur:ensureSlug},null,8,["value","onUpdate:value"])]),_:1}),o(n(C),{label:"اسلاگ",path:"slug"},{default:r(()=>[o(n(z),{value:O.value.slug,"onUpdate:value":e=>O.value.slug=e},null,8,["value","onUpdate:value"])]),_:1}),o(n(C),{label:"خلاصه",path:"shortDescription"},{default:r(()=>[o(n(z),{value:O.value.shortDescription,"onUpdate:value":e=>O.value.shortDescription=e,type:"textarea"},null,8,["value","onUpdate:value"])]),_:1}),o(n(C),{label:"توضیح کامل",path:"longDescription"},{default:r(()=>[o(n(z),{value:O.value.longDescription,"onUpdate:value":e=>O.value.longDescription=e,type:"textarea"},null,8,["value","onUpdate:value"])]),_:1}),o(n(C),{label:"قیمت (تومان)",path:"price"},{default:r(()=>[o(n(z),{value:X.value,"onUpdate:value":e=>X.value=e},null,8,["value","onUpdate:value"])]),_:1}),o(n(C),{label:"برند",path:"brandID"},{default:r(()=>[o(n(N),{value:O.value.brandID,"onUpdate:value":e=>O.value.brandID=e,options:E.value,filterable:"",clearable:""},null,8,["value","onUpdate:value","options"])]),_:1}),o(n(C),{label:"دسته‌بندی",path:"categoryID"},{default:r(()=>[o(n(N),{value:O.value.categoryID,"onUpdate:value":e=>O.value.categoryID=e,options:L.value,filterable:"",clearable:""},null,8,["value","onUpdate:value","options"])]),_:1}),o(n(C),{label:"وضعیت",path:"statusID"},{default:r(()=>[o(n(N),{value:O.value.statusID,"onUpdate:value":e=>O.value.statusID=e,options:W.value,filterable:"",clearable:""},null,8,["value","onUpdate:value","options"])]),_:1}),o(n(C),{label:"فعال"},{default:r(()=>[o(n(G),{value:O.value.isActive,"onUpdate:value":e=>O.value.isActive=e},null,8,["value","onUpdate:value"])]),_:1}),o("div",{class:"pt-2 flex items-center gap-2"},[o(n(w),{type:"primary",loading:q.value,onClick:onSubmit},{default:r(()=>[i("ذخیره")]),_:1},8,["loading"]),o(n(w),{type:"error",secondary:"",loading:F.value,onClick:onDelete},{default:r(()=>[i("حذف")]),_:1},8,["loading"])])];a(f(n(C),{label:"نام",path:"name"},{default:r((e,a,l,t)=>{if(!a)return[o(n(z),{value:O.value.name,"onUpdate:value":e=>O.value.name=e,onBlur:ensureSlug},null,8,["value","onUpdate:value"])];a(f(n(z),{value:O.value.name,"onUpdate:value":e=>O.value.name=e,onBlur:ensureSlug},null,l,t))}),_:1},l,t)),a(f(n(C),{label:"اسلاگ",path:"slug"},{default:r((e,a,l,t)=>{if(!a)return[o(n(z),{value:O.value.slug,"onUpdate:value":e=>O.value.slug=e},null,8,["value","onUpdate:value"])];a(f(n(z),{value:O.value.slug,"onUpdate:value":e=>O.value.slug=e},null,l,t))}),_:1},l,t)),a(f(n(C),{label:"خلاصه",path:"shortDescription"},{default:r((e,a,l,t)=>{if(!a)return[o(n(z),{value:O.value.shortDescription,"onUpdate:value":e=>O.value.shortDescription=e,type:"textarea"},null,8,["value","onUpdate:value"])];a(f(n(z),{value:O.value.shortDescription,"onUpdate:value":e=>O.value.shortDescription=e,type:"textarea"},null,l,t))}),_:1},l,t)),a(f(n(C),{label:"توضیح کامل",path:"longDescription"},{default:r((e,a,l,t)=>{if(!a)return[o(n(z),{value:O.value.longDescription,"onUpdate:value":e=>O.value.longDescription=e,type:"textarea"},null,8,["value","onUpdate:value"])];a(f(n(z),{value:O.value.longDescription,"onUpdate:value":e=>O.value.longDescription=e,type:"textarea"},null,l,t))}),_:1},l,t)),a(f(n(C),{label:"قیمت (تومان)",path:"price"},{default:r((e,a,l,t)=>{if(!a)return[o(n(z),{value:X.value,"onUpdate:value":e=>X.value=e},null,8,["value","onUpdate:value"])];a(f(n(z),{value:X.value,"onUpdate:value":e=>X.value=e},null,l,t))}),_:1},l,t)),a(f(n(C),{label:"برند",path:"brandID"},{default:r((e,a,l,t)=>{if(!a)return[o(n(N),{value:O.value.brandID,"onUpdate:value":e=>O.value.brandID=e,options:E.value,filterable:"",clearable:""},null,8,["value","onUpdate:value","options"])];a(f(n(N),{value:O.value.brandID,"onUpdate:value":e=>O.value.brandID=e,options:E.value,filterable:"",clearable:""},null,l,t))}),_:1},l,t)),a(f(n(C),{label:"دسته‌بندی",path:"categoryID"},{default:r((e,a,l,t)=>{if(!a)return[o(n(N),{value:O.value.categoryID,"onUpdate:value":e=>O.value.categoryID=e,options:L.value,filterable:"",clearable:""},null,8,["value","onUpdate:value","options"])];a(f(n(N),{value:O.value.categoryID,"onUpdate:value":e=>O.value.categoryID=e,options:L.value,filterable:"",clearable:""},null,l,t))}),_:1},l,t)),a(f(n(C),{label:"وضعیت",path:"statusID"},{default:r((e,a,l,t)=>{if(!a)return[o(n(N),{value:O.value.statusID,"onUpdate:value":e=>O.value.statusID=e,options:W.value,filterable:"",clearable:""},null,8,["value","onUpdate:value","options"])];a(f(n(N),{value:O.value.statusID,"onUpdate:value":e=>O.value.statusID=e,options:W.value,filterable:"",clearable:""},null,l,t))}),_:1},l,t)),a(f(n(C),{label:"فعال"},{default:r((e,a,l,t)=>{if(!a)return[o(n(G),{value:O.value.isActive,"onUpdate:value":e=>O.value.isActive=e},null,8,["value","onUpdate:value"])];a(f(n(G),{value:O.value.isActive,"onUpdate:value":e=>O.value.isActive=e},null,l,t))}),_:1},l,t)),a(`<div class="pt-2 flex items-center gap-2"${t}>`),a(f(n(w),{type:"primary",loading:q.value,onClick:onSubmit},{default:r((e,a,l,t)=>{if(!a)return[i("ذخیره")];a("ذخیره")}),_:1},l,t)),a(f(n(w),{type:"error",secondary:"",loading:F.value,onClick:onDelete},{default:r((e,a,l,t)=>{if(!a)return[i("حذف")];a("حذف")}),_:1},l,t)),a("</div>")}),_:1},l,t))}),_:1},t)),l(f(n(x),{class:"rounded-2xl ring-1 ring-slate-200/80 shadow-sm",bordered:!1},{header:r((e,a,l,t)=>{if(!a)return[i("گالری تصاویر")];a("گالری تصاویر")}),default:r((e,a,l,t)=>{if(!a)return[o("div",{class:"space-y-3"},[o("div",{class:"flex items-center gap-3"},[o("input",{ref_key:"fileInput",ref:Y,type:"file",multiple:"",accept:"image/*"},null,512),o(n(w),{loading:K.value,size:"small",onClick:uploadSelected},{default:r(()=>[i("آپلود تصاویر")]),_:1},8,["loading"])]),o("div",{class:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3"},[(v(!0),s(d,null,p(J.value,e=>(v(),s("div",{key:e.id,class:"rounded-xl border border-slate-200 p-2"},[o("img",{src:fullUrl(e.path),class:"h-28 w-full object-cover rounded-lg"},null,8,["src"]),o("div",{class:"flex items-center justify-between mt-2"},[o(n(w),{size:"tiny",type:e.isMain?"primary":"default",onClick:a=>setMain(e)},{default:r(()=>[i("اصلی")]),_:1},8,["type","onClick"]),o(n(G),{size:"small",value:e.isActive,"onUpdate:value":[a=>e.isActive=a,a=>toggleActive(e,a)]},null,8,["value","onUpdate:value"]),o(n(w),{size:"tiny",type:"error",secondary:"",onClick:a=>removeGallery(e)},{default:r(()=>[i("حذف")]),_:1},8,["onClick"])])]))),128))])])];a(`<div class="space-y-3"${t}><div class="flex items-center gap-3"${t}><input type="file" multiple accept="image/*"${t}>`),a(f(n(w),{loading:K.value,size:"small",onClick:uploadSelected},{default:r((e,a,l,t)=>{if(!a)return[i("آپلود تصاویر")];a("آپلود تصاویر")}),_:1},l,t)),a(`</div><div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3"${t}>\x3c!--[--\x3e`),g(J.value,e=>{a(`<div class="rounded-xl border border-slate-200 p-2"${t}><img${b("src",fullUrl(e.path))} class="h-28 w-full object-cover rounded-lg"${t}><div class="flex items-center justify-between mt-2"${t}>`),a(f(n(w),{size:"tiny",type:e.isMain?"primary":"default",onClick:a=>setMain(e)},{default:r((e,a,l,t)=>{if(!a)return[i("اصلی")];a("اصلی")}),_:2},l,t)),a(f(n(G),{size:"small",value:e.isActive,"onUpdate:value":[a=>e.isActive=a,a=>toggleActive(e,a)]},null,l,t)),a(f(n(w),{size:"tiny",type:"error",secondary:"",onClick:a=>removeGallery(e)},{default:r((e,a,l,t)=>{if(!a)return[i("حذف")];a("حذف")}),_:2},l,t)),a("</div></div>")}),a("\x3c!--]--\x3e</div></div>")}),_:1},t)),l("</section>")}}}),T=B.setup;B.setup=(e,a)=>{const l=c();return(l.modules||(l.modules=new Set)).add("pages/admin/products/[id].vue"),T?T(e,a):void 0};export{B as default};
//# sourceMappingURL=_id_-ts9AxhHS.mjs.map
